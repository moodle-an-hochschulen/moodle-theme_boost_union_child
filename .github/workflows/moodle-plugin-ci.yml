name: Moodle Plugin CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      moodle-core-branch:
        description: 'Moodle core branch to test against (if not provided, the branch will be auto-detected)'
        required: false
        type: string
  repository_dispatch:
    types: [moodle-plugin-ci]

jobs:
  moodle-plugin-ci:
    uses: moodle-an-hochschulen/moodle-workflows/.github/workflows/moodle-plugin-ci.yml@main
    with:
      moodle-core-branch: ${{ inputs.moodle-core-branch || github.event.client_payload.moodle-core-branch }}
      plugin-dependencies: |
        moodle-an-hochschulen/moodle-theme_boost_union,main
      pre-install-script: |
        # Copy and modify Boost Union Behat tests to be used on Boost Union Child.
        #
        # The Moodle Behat init script ignores Behat features from themes which are not active.
        # However, our goal is to run all Boost Union tests on Boost Union Child to verify that Boost Union Child
        # does not break any of Boost Union's features.
        # To realize this, we copy the Boost Union feature files to the Boost Union child test directory.
        # The Behat init script won't ignore them there then.
        #
        # Copy the Boost Union feature files to a temporary folder.
        mkdir plugin/tests/behatbu
        cp moodle-plugin-ci-plugins/moodle-theme_boost_union/tests/behat/*.feature plugin/tests/behatbu/
        # Add a suffix to the feature title in the Boost Union features.
        # This is necessary as the Moodle code checker would otherwise complain about duplicate feature names.
        sed -i '/^Feature:/ s/$/ - Running on Boost Union Child/' plugin/tests/behatbu/*.feature
        # Add the @theme_boost_union_child tag to the tag list of the Boost Union features.
        # This is necessary as the Moodle plugin validator would otherwise complain about the missing tag.
        sed -i '1 s/$/ @theme_boost_union_child/' plugin/tests/behatbu/*.feature
        # Move the modified Boost Union feature files to the Boost Union Child Behat test directory.
        mv plugin/tests/behatbu/*.feature plugin/tests/behat/
        rm -rf plugin/tests/behatbu
      pr-check-diff-does-not-contain: "theme->settings->"
      behat-suite: "boost_union_child"
      behat-timeout: 3 # Required for theme_boost_union_general.feature
      behat-tags: "@theme_boost_union,@theme_boost_union_child"
